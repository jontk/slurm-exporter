apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: slurm-exporter
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: ingress
  annotations:
    # NGINX Ingress Controller annotations
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    
    # Rate limiting
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
    
    # Authentication (optional - uncomment if needed)
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: basic-auth
    # nginx.ingress.kubernetes.io/auth-realm: "SLURM Exporter Authentication"
    
    # IP whitelisting for security
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
    
    # Load balancing
    nginx.ingress.kubernetes.io/load-balance: "round_robin"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
    
    # Health checks
    nginx.ingress.kubernetes.io/health-check-path: "/health"
    nginx.ingress.kubernetes.io/health-check-interval: "10"
    nginx.ingress.kubernetes.io/health-check-timeout: "5"
    
    # Certificate management
    cert-manager.io/issuer: "letsencrypt-prod"
    cert-manager.io/acme-challenge-type: "http01"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Content-Type-Options nosniff;
      add_header X-Frame-Options DENY;
      add_header X-XSS-Protection "1; mode=block";
      add_header Referrer-Policy "strict-origin-when-cross-origin";
      add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';";
spec:
  ingressClassName: nginx
  
  tls:
  - hosts:
    - slurm-exporter.example.com
    - slurm-metrics.example.com
    secretName: slurm-exporter-tls
  
  rules:
  - host: slurm-exporter.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: slurm-exporter
            port:
              number: 10341
      - path: /metrics
        pathType: Exact
        backend:
          service:
            name: slurm-exporter
            port:
              number: 10341
      - path: /health
        pathType: Exact
        backend:
          service:
            name: slurm-exporter
            port:
              number: 8081
      - path: /ready
        pathType: Exact
        backend:
          service:
            name: slurm-exporter
            port:
              number: 8081
  
  - host: slurm-metrics.example.com
    http:
      paths:
      - path: /metrics
        pathType: Exact
        backend:
          service:
            name: slurm-exporter
            port:
              number: 10341

---
# Alternative Istio Gateway and VirtualService configuration
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: slurm-exporter-gateway
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: istio-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - slurm-exporter.example.com
    tls:
      httpsRedirect: true
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - slurm-exporter.example.com
    tls:
      mode: SIMPLE
      credentialName: slurm-exporter-tls

---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: slurm-exporter
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: istio-virtualservice
spec:
  hosts:
  - slurm-exporter.example.com
  gateways:
  - slurm-exporter-gateway
  http:
  - match:
    - uri:
        exact: /metrics
    route:
    - destination:
        host: slurm-exporter.slurm-exporter.svc.cluster.local
        port:
          number: 10341
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
  
  - match:
    - uri:
        prefix: /health
    - uri:
        prefix: /ready
    route:
    - destination:
        host: slurm-exporter.slurm-exporter.svc.cluster.local
        port:
          number: 8081
    timeout: 10s
  
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: slurm-exporter.slurm-exporter.svc.cluster.local
        port:
          number: 10341
    timeout: 30s

---
# Istio DestinationRule for load balancing and circuit breaking
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: slurm-exporter
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: istio-destinationrule
spec:
  host: slurm-exporter.slurm-exporter.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 10
        maxRetries: 3
        consecutiveGatewayErrors: 5
        interval: 30s
        baseEjectionTime: 30s
    outlierDetection:
      consecutiveGatewayErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50