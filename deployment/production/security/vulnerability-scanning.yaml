# Vulnerability Scanning and Security Assessment for SLURM Exporter
# This file implements comprehensive vulnerability management and security scanning

apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerability-scanning-config
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: vulnerability-scanning
data:
  scanning-policy.yaml: |
    # Vulnerability Scanning Policy
    vulnerability_scanning:
      # Scanning frequency
      schedule:
        container_images: "daily"
        kubernetes_configs: "weekly"
        dependencies: "daily"
        infrastructure: "weekly"
        compliance: "monthly"
      
      # Severity thresholds
      severity_thresholds:
        critical: 0      # Block deployment if any critical vulnerabilities
        high: 5          # Allow up to 5 high severity vulnerabilities
        medium: 20       # Allow up to 20 medium severity vulnerabilities
        low: 100         # Allow up to 100 low severity vulnerabilities
      
      # Scanning tools
      tools:
        - name: "trivy"
          type: "container_scanner"
          enabled: true
          config:
            severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
            vuln_type: "os,library"
            security_checks: "vuln,config,secret"
        
        - name: "grype"
          type: "container_scanner"
          enabled: true
          config:
            fail_on: "high"
            scope: "all-layers"
        
        - name: "kube-bench"
          type: "kubernetes_scanner"
          enabled: true
          config:
            benchmark: "cis-1.6"
        
        - name: "falco"
          type: "runtime_scanner"
          enabled: true
          config:
            rules: "custom,default"
        
        - name: "polaris"
          type: "configuration_scanner"
          enabled: true
          config:
            checks: "security,efficiency,reliability"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: container-vulnerability-scan
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: vulnerability-scanning
    scan-type: container
spec:
  schedule: "0 1 * * *"  # Daily at 1 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: slurm-exporter
            component: vulnerability-scanning
            scan-type: container
        spec:
          restartPolicy: Never
          
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            fsGroup: 65534
          
          containers:
          - name: trivy-scanner
            image: aquasec/trivy:latest
            imagePullPolicy: IfNotPresent
            
            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            
            env:
            - name: TRIVY_CACHE_DIR
              value: "/tmp/trivy-cache"
            - name: TRIVY_DB_REPOSITORY
              value: "ghcr.io/aquasecurity/trivy-db"
            - name: TRIVY_JAVA_DB_REPOSITORY
              value: "ghcr.io/aquasecurity/trivy-java-db"
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: security-notifications
                  key: slack-webhook
            - name: SCAN_DATE
              value: "$(date +%Y-%m-%d)"
            
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "Starting container vulnerability scan"
              
              # Function to send Slack notification
              send_notification() {
                local message="$1"
                local status="$2"
                
                if [ "$status" = "critical" ]; then
                  emoji=":rotating_light:"
                  color="danger"
                elif [ "$status" = "warning" ]; then
                  emoji=":warning:"
                  color="warning"
                else
                  emoji=":shield:"
                  color="good"
                fi
                
                curl -X POST "$SLACK_WEBHOOK" \
                  -H 'Content-type: application/json' \
                  --data "{
                    \"attachments\": [{
                      \"color\": \"$color\",
                      \"text\": \"$emoji SLURM Exporter Security Scan\\n$message\"
                    }]
                  }" || true
              }
              
              # Update vulnerability database
              echo "Updating Trivy database..."
              trivy --cache-dir /tmp/trivy-cache image --download-db-only
              
              # Scan SLURM Exporter container image
              IMAGE="ghcr.io/jontk/slurm-exporter:v1.0.0"
              echo "Scanning image: $IMAGE"
              
              # Run vulnerability scan
              trivy --cache-dir /tmp/trivy-cache image \
                --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
                --format json \
                --output /tmp/scan-results.json \
                "$IMAGE"
              
              # Parse results
              CRITICAL_COUNT=$(cat /tmp/scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length')
              HIGH_COUNT=$(cat /tmp/scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length')
              MEDIUM_COUNT=$(cat /tmp/scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length')
              LOW_COUNT=$(cat /tmp/scan-results.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "LOW")] | length')
              
              echo "Vulnerability Summary:"
              echo "Critical: $CRITICAL_COUNT"
              echo "High: $HIGH_COUNT"
              echo "Medium: $MEDIUM_COUNT"
              echo "Low: $LOW_COUNT"
              
              # Generate detailed report
              trivy --cache-dir /tmp/trivy-cache image \
                --severity CRITICAL,HIGH \
                --format table \
                --output /tmp/critical-high-report.txt \
                "$IMAGE"
              
              # Check against policy thresholds
              VIOLATIONS=0
              VIOLATION_MSG=""
              
              if [ "$CRITICAL_COUNT" -gt 0 ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
                VIOLATION_MSG="${VIOLATION_MSG}\nâŒ Critical vulnerabilities: $CRITICAL_COUNT (threshold: 0)"
              fi
              
              if [ "$HIGH_COUNT" -gt 5 ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
                VIOLATION_MSG="${VIOLATION_MSG}\nâŒ High vulnerabilities: $HIGH_COUNT (threshold: 5)"
              fi
              
              if [ "$MEDIUM_COUNT" -gt 20 ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
                VIOLATION_MSG="${VIOLATION_MSG}\nâŒ Medium vulnerabilities: $MEDIUM_COUNT (threshold: 20)"
              fi
              
              # Create summary report
              cat > /tmp/scan-summary.json << EOF
              {
                "scan_date": "${SCAN_DATE}",
                "image": "${IMAGE}",
                "vulnerability_counts": {
                  "critical": ${CRITICAL_COUNT},
                  "high": ${HIGH_COUNT},
                  "medium": ${MEDIUM_COUNT},
                  "low": ${LOW_COUNT}
                },
                "policy_violations": ${VIOLATIONS},
                "status": "$([ $VIOLATIONS -eq 0 ] && echo 'PASS' || echo 'FAIL')"
              }
              EOF
              
              # Send notifications based on results
              if [ "$VIOLATIONS" -gt 0 ]; then
                SUMMARY="ðŸš¨ Security vulnerabilities detected in SLURM Exporter container image:\\n"
                SUMMARY="${SUMMARY}Critical: $CRITICAL_COUNT | High: $HIGH_COUNT | Medium: $MEDIUM_COUNT | Low: $LOW_COUNT\\n"
                SUMMARY="${SUMMARY}Policy violations: $VIOLATIONS"
                SUMMARY="${SUMMARY}$VIOLATION_MSG"
                
                send_notification "$SUMMARY" "critical"
                
                echo "Vulnerability scan FAILED - policy violations detected"
                exit 1
              else
                SUMMARY="âœ… Container vulnerability scan completed successfully\\n"
                SUMMARY="${SUMMARY}Critical: $CRITICAL_COUNT | High: $HIGH_COUNT | Medium: $MEDIUM_COUNT | Low: $LOW_COUNT\\n"
                SUMMARY="${SUMMARY}All vulnerabilities within acceptable thresholds"
                
                send_notification "$SUMMARY" "success"
                
                echo "Vulnerability scan PASSED"
              fi
            
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 1000m
                memory: 2Gi
            
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /tmp/trivy-cache
          
          volumes:
          - name: tmp
            emptyDir:
              sizeLimit: 1Gi
          - name: cache
            emptyDir:
              sizeLimit: 2Gi

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kubernetes-security-scan
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: vulnerability-scanning
    scan-type: kubernetes
spec:
  schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: slurm-exporter
            component: vulnerability-scanning
            scan-type: kubernetes
        spec:
          restartPolicy: Never
          serviceAccountName: security-scanner
          
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            fsGroup: 65534
          
          containers:
          - name: kube-bench
            image: aquasec/kube-bench:latest
            imagePullPolicy: IfNotPresent
            
            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            
            env:
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: security-notifications
                  key: slack-webhook
            
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "Starting Kubernetes security benchmark scan"
              
              # Function to send notification
              send_notification() {
                local message="$1"
                local status="$2"
                
                if [ "$status" = "warning" ]; then
                  emoji=":warning:"
                  color="warning"
                else
                  emoji=":shield:"
                  color="good"
                fi
                
                curl -X POST "$SLACK_WEBHOOK" \
                  -H 'Content-type: application/json' \
                  --data "{
                    \"attachments\": [{
                      \"color\": \"$color\",
                      \"text\": \"$emoji Kubernetes Security Scan\\n$message\"
                    }]
                  }" || true
              }
              
              # Run kube-bench CIS benchmark
              echo "Running CIS Kubernetes Benchmark..."
              kube-bench --json > /tmp/kube-bench-results.json
              
              # Parse results
              TOTAL_CHECKS=$(cat /tmp/kube-bench-results.json | jq '[.Controls[]?.tests[]?.results[]?] | length')
              PASS_COUNT=$(cat /tmp/kube-bench-results.json | jq '[.Controls[]?.tests[]?.results[]? | select(.test_result == "PASS")] | length')
              FAIL_COUNT=$(cat /tmp/kube-bench-results.json | jq '[.Controls[]?.tests[]?.results[]? | select(.test_result == "FAIL")] | length')
              WARN_COUNT=$(cat /tmp/kube-bench-results.json | jq '[.Controls[]?.tests[]?.results[]? | select(.test_result == "WARN")] | length')
              
              PASS_RATE=$((PASS_COUNT * 100 / TOTAL_CHECKS))
              
              echo "CIS Benchmark Results:"
              echo "Total checks: $TOTAL_CHECKS"
              echo "Pass: $PASS_COUNT"
              echo "Fail: $FAIL_COUNT"
              echo "Warn: $WARN_COUNT"
              echo "Pass rate: $PASS_RATE%"
              
              # Check if pass rate is acceptable (>80%)
              if [ "$PASS_RATE" -lt 80 ]; then
                SUMMARY="âš ï¸ Kubernetes security benchmark failed\\n"
                SUMMARY="${SUMMARY}Pass rate: $PASS_RATE% (minimum: 80%)\\n"
                SUMMARY="${SUMMARY}Failed checks: $FAIL_COUNT | Warnings: $WARN_COUNT"
                
                send_notification "$SUMMARY" "warning"
                echo "Security benchmark FAILED - pass rate below threshold"
              else
                SUMMARY="âœ… Kubernetes security benchmark completed\\n"
                SUMMARY="${SUMMARY}Pass rate: $PASS_RATE%\\n"
                SUMMARY="${SUMMARY}Passed: $PASS_COUNT | Failed: $FAIL_COUNT | Warnings: $WARN_COUNT"
                
                send_notification "$SUMMARY" "success"
                echo "Security benchmark PASSED"
              fi
            
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi
            
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          
          - name: polaris-scanner
            image: quay.io/fairwinds/polaris:latest
            imagePullPolicy: IfNotPresent
            
            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "Starting Polaris configuration scan"
              
              # Run Polaris audit on SLURM Exporter namespace
              polaris audit --format json --namespace slurm-exporter > /tmp/polaris-results.json
              
              # Parse results
              TOTAL_CHECKS=$(cat /tmp/polaris-results.json | jq '.AuditData.Results | length')
              PASS_COUNT=$(cat /tmp/polaris-results.json | jq '[.AuditData.Results[] | select(.PodResult.Results.Summary.passes > 0)] | length')
              
              echo "Polaris configuration scan completed"
              echo "Resources scanned: $TOTAL_CHECKS"
              echo "Passing resources: $PASS_COUNT"
            
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 300m
                memory: 256Mi
            
            volumeMounts:
            - name: tmp
              mountPath: /tmp
          
          volumes:
          - name: tmp
            emptyDir:
              sizeLimit: 500Mi

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dependency-vulnerability-scan
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: vulnerability-scanning
    scan-type: dependencies
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: slurm-exporter
            component: vulnerability-scanning
            scan-type: dependencies
        spec:
          restartPolicy: Never
          
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            fsGroup: 65534
          
          containers:
          - name: grype-scanner
            image: anchore/grype:latest
            imagePullPolicy: IfNotPresent
            
            securityContext:
              runAsNonRoot: true
              runAsUser: 65534
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                - ALL
            
            env:
            - name: GRYPE_DB_CACHE_DIR
              value: "/tmp/grype-cache"
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: security-notifications
                  key: slack-webhook
            
            command:
            - /bin/sh
            - -c
            - |
              set -e
              
              echo "Starting dependency vulnerability scan with Grype"
              
              # Function to send notification
              send_notification() {
                local message="$1"
                local status="$2"
                
                if [ "$status" = "critical" ]; then
                  emoji=":rotating_light:"
                  color="danger"
                elif [ "$status" = "warning" ]; then
                  emoji=":warning:"
                  color="warning"
                else
                  emoji=":white_check_mark:"
                  color="good"
                fi
                
                curl -X POST "$SLACK_WEBHOOK" \
                  -H 'Content-type: application/json' \
                  --data "{
                    \"attachments\": [{
                      \"color\": \"$color\",
                      \"text\": \"$emoji Dependency Vulnerability Scan\\n$message\"
                    }]
                  }" || true
              }
              
              # Update vulnerability database
              echo "Updating Grype database..."
              grype db update
              
              # Scan SLURM Exporter image for dependency vulnerabilities
              IMAGE="ghcr.io/jontk/slurm-exporter:v1.0.0"
              echo "Scanning dependencies in: $IMAGE"
              
              # Run dependency scan
              grype "$IMAGE" -o json > /tmp/grype-results.json
              
              # Parse results by severity
              CRITICAL_DEPS=$(cat /tmp/grype-results.json | jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length')
              HIGH_DEPS=$(cat /tmp/grype-results.json | jq '[.matches[] | select(.vulnerability.severity == "High")] | length')
              MEDIUM_DEPS=$(cat /tmp/grype-results.json | jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length')
              LOW_DEPS=$(cat /tmp/grype-results.json | jq '[.matches[] | select(.vulnerability.severity == "Low")] | length')
              
              echo "Dependency Vulnerability Summary:"
              echo "Critical: $CRITICAL_DEPS"
              echo "High: $HIGH_DEPS"  
              echo "Medium: $MEDIUM_DEPS"
              echo "Low: $LOW_DEPS"
              
              # Check against thresholds
              VIOLATIONS=0
              
              if [ "$CRITICAL_DEPS" -gt 0 ]; then
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
              
              if [ "$HIGH_DEPS" -gt 10 ]; then  # Allow up to 10 high severity dependency issues
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
              
              # Generate report
              if [ "$VIOLATIONS" -gt 0 ]; then
                SUMMARY="ðŸš¨ Critical dependency vulnerabilities found:\\n"
                SUMMARY="${SUMMARY}Critical: $CRITICAL_DEPS | High: $HIGH_DEPS | Medium: $MEDIUM_DEPS"
                
                send_notification "$SUMMARY" "critical"
                echo "Dependency scan FAILED"
                exit 1
              else
                SUMMARY="âœ… Dependency vulnerability scan completed\\n"
                SUMMARY="${SUMMARY}Critical: $CRITICAL_DEPS | High: $HIGH_DEPS | Medium: $MEDIUM_DEPS | Low: $LOW_DEPS"
                
                send_notification "$SUMMARY" "success"
                echo "Dependency scan PASSED"
              fi
            
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
              limits:
                cpu: 1000m
                memory: 2Gi
            
            volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /tmp/grype-cache
          
          volumes:
          - name: tmp
            emptyDir:
              sizeLimit: 1Gi
          - name: cache
            emptyDir:
              sizeLimit: 2Gi

---
# Runtime Security Scanning with Falco
apiVersion: v1
kind: ConfigMap
metadata:
  name: falco-rules-slurm-exporter
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: runtime-security
data:
  slurm_exporter_rules.yaml: |
    # Custom Falco rules for SLURM Exporter security monitoring
    
    - list: slurm_exporter_containers
      items: [slurm-exporter]
    
    - list: slurm_allowed_processes
      items: [slurm-exporter, sleep, sh, bash, curl, wget]
    
    - list: slurm_sensitive_files
      items: [/etc/slurm-credentials, /etc/ssl, /etc/passwd, /etc/shadow]
    
    - rule: Unauthorized Process in SLURM Exporter
      desc: Detect unauthorized processes in SLURM Exporter container
      condition: >
        container.name in (slurm_exporter_containers) and
        spawned_process and
        not proc.name in (slurm_allowed_processes)
      output: >
        Unauthorized process in SLURM Exporter
        (user=%user.name process=%proc.name cmdline=%proc.cmdline container=%container.name)
      priority: HIGH
      tags: [container, slurm-exporter, process]
    
    - rule: SLURM Exporter File Access Violation
      desc: Detect unauthorized file access in SLURM Exporter
      condition: >
        container.name in (slurm_exporter_containers) and
        (open_read or open_write) and
        fd.name in (slurm_sensitive_files)
      output: >
        Sensitive file access in SLURM Exporter
        (user=%user.name file=%fd.name mode=%evt.arg.flags container=%container.name)
      priority: MEDIUM
      tags: [filesystem, slurm-exporter, access]
    
    - rule: SLURM Exporter Network Anomaly
      desc: Detect unusual network activity from SLURM Exporter
      condition: >
        container.name in (slurm_exporter_containers) and
        (outbound) and
        not fd.sip in (slurm_api_networks) and
        not fd.sport in (53, 443, 6820, 6821, 10341)
      output: >
        Unusual network connection from SLURM Exporter
        (destination=%fd.sip:%fd.sport protocol=%fd.l4proto container=%container.name)
      priority: HIGH
      tags: [network, slurm-exporter, anomaly]
    
    - rule: SLURM Exporter Privilege Escalation
      desc: Detect privilege escalation attempts in SLURM Exporter
      condition: >
        container.name in (slurm_exporter_containers) and
        (setuid or setgid or spawned_process) and
        (proc.aname[2] != "" or proc.aname[3] != "") and
        proc.pname exists
      output: >
        Privilege escalation attempt in SLURM Exporter
        (user=%user.name process=%proc.name parent=%proc.pname container=%container.name)
      priority: CRITICAL
      tags: [privilege-escalation, slurm-exporter, security]

---
# Vulnerability scanning RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: security-scanner
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: security-scanning

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: security-scanner
  labels:
    app: slurm-exporter
    component: security-scanning
rules:
# Read access for security scanning
- apiGroups: [""]
  resources: ["pods", "services", "configmaps", "secrets"]
  verbs: ["get", "list"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "daemonsets"]
  verbs: ["get", "list"]
- apiGroups: ["networking.k8s.io"]
  resources: ["networkpolicies"]
  verbs: ["get", "list"]
- apiGroups: ["policy"]
  resources: ["podsecuritypolicies"]
  verbs: ["get", "list"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: security-scanner
  labels:
    app: slurm-exporter
    component: security-scanning
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: security-scanner
subjects:
- kind: ServiceAccount
  name: security-scanner
  namespace: slurm-exporter

---
# Vulnerability monitoring and alerting
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: vulnerability-scanning-alerts
  namespace: slurm-exporter
  labels:
    app: slurm-exporter
    component: vulnerability-scanning
spec:
  groups:
  - name: vulnerability-scanning
    rules:
    - alert: CriticalVulnerabilitiesDetected
      expr: kube_job_status_failed{job_name=~"container-vulnerability-scan.*"} > 0
      for: 0m
      labels:
        severity: critical
        component: vulnerability-scanning
      annotations:
        summary: "Critical vulnerabilities detected in container scan"
        description: "Container vulnerability scan has detected critical security issues"
        action: "Review scan results and update container image"
    
    - alert: SecurityScanFailed
      expr: kube_job_status_failed{job_name=~".*vulnerability-scan.*"} > 0
      for: 5m
      labels:
        severity: warning
        component: vulnerability-scanning
      annotations:
        summary: "Security vulnerability scan failed"
        description: "Security scan job {{ $labels.job_name }} has failed"
        action: "Investigate scan failure and ensure security monitoring is active"
    
    - alert: SecurityScanOverdue
      expr: (time() - kube_job_status_completion_time{job_name=~"container-vulnerability-scan.*"}) > 172800  # 48 hours
      for: 0m
      labels:
        severity: warning
        component: vulnerability-scanning
      annotations:
        summary: "Security vulnerability scan overdue"
        description: "Container vulnerability scan has not completed in over 48 hours"
        action: "Check scan job status and troubleshoot if necessary"
    
    - alert: RuntimeSecurityViolation
      expr: increase(falco_events_total{rule_name=~".*SLURM.*Exporter.*"}[5m]) > 0
      for: 0m
      labels:
        severity: critical
        component: runtime-security
      annotations:
        summary: "Runtime security violation in SLURM Exporter"
        description: "Falco has detected security violations in SLURM Exporter containers"
        action: "Immediate investigation required - potential security breach"