---
apiVersion: v1
kind: ConfigMap
metadata:
  name: slurm-exporter-config
  namespace: monitoring
  labels:
    app: slurm-exporter
    component: configuration
data:
  config.yaml: |
    # SLURM Prometheus Exporter Configuration
    # Production configuration for Kubernetes deployment

    # Server configuration
    server:
      address: ":8080"
      metrics_path: "/metrics"
      health_path: "/health"
      ready_path: "/ready"
      timeout: "30s"
      read_timeout: "15s"
      write_timeout: "15s"
      idle_timeout: "60s"
      max_request_size: 1048576  # 1MB

      # TLS configuration (configure as needed)
      tls:
        enabled: false
        cert_file: "/etc/ssl/slurm-exporter/tls.crt"
        key_file: "/etc/ssl/slurm-exporter/tls.key"
        min_version: "1.2"
        cipher_suites:
          - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
          - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
          - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
          - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"

      # Basic authentication (configure as needed)
      basic_auth:
        enabled: false
        username: ""
        password: ""

      # CORS configuration
      cors:
        enabled: false
        allowed_origins: []
        allowed_methods: ["GET"]
        allowed_headers: []

    # SLURM connection configuration
    slurm:
      base_url: "https://slurm-api.example.com:6820"  # Update with your SLURM REST API endpoint
      api_version: "v0.0.42"
      timeout: "30s"
      retry_attempts: 3
      retry_delay: "5s"

      # Authentication configuration
      auth:
        type: "jwt"  # Options: none, jwt, basic, apikey
        token_file: "/etc/slurm-exporter/secrets/token"  # JWT token file
        # For other auth types, uncomment as needed:
        # username: "slurm-user"
        # password_file: "/etc/slurm-exporter/secrets/password"
        # api_key_file: "/etc/slurm-exporter/secrets/apikey"

      # Connection pool settings
      max_idle_conns: 10
      max_conns_per_host: 20
      idle_conn_timeout: "90s"

    # Collectors configuration
    collectors:
      cluster:
        enabled: true
        interval: "60s"

      node:
        enabled: true
        interval: "60s"

      job:
        enabled: true
        interval: "30s"

      user:
        enabled: true
        interval: "120s"

      partition:
        enabled: true
        interval: "90s"

      performance:
        enabled: true
        interval: "60s"

      scheduler:
        enabled: true
        interval: "60s"

      selfmon:
        enabled: true
        interval: "30s"

    # Logging configuration
    logging:
      level: "info"
      format: "json"
      output: "stdout"
      add_caller: false
      disable_stacktrace: true

    # Metrics configuration
    metrics:
      namespace: "slurm"
      max_cardinality: 50000
      cardinality_check_interval: "300s"

---
# ConfigMap for production environment overrides
apiVersion: v1
kind: ConfigMap
metadata:
  name: slurm-exporter-config-prod
  namespace: monitoring
  labels:
    app: slurm-exporter
    component: configuration
    environment: production
data:
  config.yaml: |
    # Production-specific SLURM Exporter Configuration

    server:
      address: ":8080"
      metrics_path: "/metrics"
      health_path: "/health"
      ready_path: "/ready"
      timeout: "30s"
      read_timeout: "15s"
      write_timeout: "15s"
      idle_timeout: "60s"
      max_request_size: 1048576

      tls:
        enabled: true
        cert_file: "/etc/ssl/slurm-exporter/tls.crt"
        key_file: "/etc/ssl/slurm-exporter/tls.key"
        min_version: "1.2"

      basic_auth:
        enabled: true
        username: "prometheus"
        password: "secure-password"  # Use Secret for production

    slurm:
      base_url: "https://slurm-cluster.internal:6820"
      api_version: "v0.0.42"
      timeout: "45s"
      retry_attempts: 5
      retry_delay: "10s"

      auth:
        type: "jwt"
        token_file: "/etc/slurm-exporter/secrets/jwt-token"

    collectors:
      cluster:
        enabled: true
        interval: "120s"  # Less frequent in production

      node:
        enabled: true
        interval: "90s"

      job:
        enabled: true
        interval: "60s"

      user:
        enabled: true
        interval: "300s"  # Less frequent user metrics

      partition:
        enabled: true
        interval: "180s"

      performance:
        enabled: true
        interval: "120s"

      scheduler:
        enabled: true
        interval: "120s"

      selfmon:
        enabled: true
        interval: "60s"

    logging:
      level: "warn"  # Less verbose in production
      format: "json"
      output: "stdout"
      add_caller: false
      disable_stacktrace: true

    metrics:
      namespace: "slurm"
      max_cardinality: 100000  # Higher limit for production
      cardinality_check_interval: "600s"

---
# ConfigMap for staging environment
apiVersion: v1
kind: ConfigMap
metadata:
  name: slurm-exporter-config-staging
  namespace: monitoring
  labels:
    app: slurm-exporter
    component: configuration
    environment: staging
data:
  config.yaml: |
    # Staging environment configuration

    server:
      address: ":8080"
      metrics_path: "/metrics"
      health_path: "/health"
      ready_path: "/ready"
      timeout: "30s"
      read_timeout: "10s"
      write_timeout: "10s"
      idle_timeout: "60s"

      tls:
        enabled: false  # Disabled for staging simplicity

      basic_auth:
        enabled: false  # Disabled for staging testing

    slurm:
      base_url: "http://slurm-staging.internal:6820"
      api_version: "v0.0.42"
      timeout: "30s"
      retry_attempts: 3
      retry_delay: "5s"

      auth:
        type: "basic"
        username: "staging-user"
        password_file: "/etc/slurm-exporter/secrets/staging-password"

    collectors:
      cluster:
        enabled: true
        interval: "60s"

      node:
        enabled: true
        interval: "60s"

      job:
        enabled: true
        interval: "30s"  # More frequent for testing

      user:
        enabled: true
        interval: "120s"

      partition:
        enabled: true
        interval: "90s"

      performance:
        enabled: true
        interval: "60s"

      scheduler:
        enabled: true
        interval: "60s"

      selfmon:
        enabled: true
        interval: "30s"

    logging:
      level: "info"
      format: "json"
      output: "stdout"
      add_caller: true  # Helpful for staging debugging
      disable_stacktrace: false

    metrics:
      namespace: "slurm"
      max_cardinality: 75000
      cardinality_check_interval: "300s"