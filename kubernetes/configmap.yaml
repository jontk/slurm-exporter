apiVersion: v1
kind: ConfigMap
metadata:
  name: slurm-exporter-config
  namespace: slurm-monitoring
  labels:
    app.kubernetes.io/name: slurm-exporter
    app.kubernetes.io/part-of: slurm-monitoring
data:
  config.yaml: |
    # SLURM Exporter Configuration
    server:
      address: ":8080"
      metrics_path: "/metrics"
      read_timeout: 30s
      write_timeout: 30s
      max_request_size: 10485760  # 10MB
      
    # SLURM connection configuration
    slurm:
      base_url: "${SLURM_BASE_URL}"  # Set via environment variable
      timeout: 30s
      auth:
        type: "${SLURM_AUTH_TYPE}"  # jwt, basic, or token
        jwt_path: "${SLURM_JWT_PATH:-/var/run/slurm-jwt}"
        username: "${SLURM_USERNAME}"
        password: "${SLURM_PASSWORD}"
        token: "${SLURM_TOKEN}"
      
    # Logging configuration
    logging:
      level: "${LOG_LEVEL:-info}"
      format: "json"
      output: "stdout"
      
    # Collectors configuration
    collectors:
      # Jobs collector
      jobs:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Nodes collector
      nodes:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Partitions collector
      partitions:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Accounts collector
      accounts:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Users collector
      users:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # QoS collector
      qos:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Reservations collector
      reservations:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Associations collector
      associations:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Cluster collector
      cluster:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Performance collector
      performance:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # System collector
      system:
        enabled: true
        filters:
          metric_filter:
            enable_all: true
        custom_labels:
          cluster_name: "${CLUSTER_NAME}"
          environment: "${ENVIRONMENT:-production}"
      
      # Cardinality limits
      cardinality_limits:
        "slurm_job_*":
          max_labels: 1000
          max_series_per_label: 100
          action: "drop"
        "slurm_node_*":
          max_labels: 500
          max_series_per_label: 50
          action: "sample"