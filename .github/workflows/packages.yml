name: Build and Publish Packages

on:
  push:
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'packaging/**'
      - '.github/workflows/packages.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  GO_VERSION: '1.24'

jobs:
  build-rpm:
    name: Build RPM Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Note: Removed centos-7 (EOL June 2024) and centos-8 (EOL Dec 2021)
        # Use Rocky Linux or AlmaLinux for RHEL 7/8 compatibility
        os: [centos-9, rocky-8, rocky-9, almalinux-8, almalinux-9, fedora-38, fedora-39]
        arch: [x86_64, aarch64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            RPM_VERSION="$VERSION"
            RPM_RELEASE="1"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            RPM_VERSION="$VERSION"
            RPM_RELEASE="1"
          else
            GIT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0.dev.${GIT_SHA}"
            RPM_VERSION="0.0.0"
            RPM_RELEASE="0.dev.git${GIT_SHA}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rpm_version=$RPM_VERSION" >> $GITHUB_OUTPUT
          echo "rpm_release=$RPM_RELEASE" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (RPM: $RPM_VERSION-$RPM_RELEASE)"

      - name: Set Docker image
        id: docker_image
        run: |
          # Convert matrix OS name to proper Docker image name
          os="${{ matrix.os }}"
          case "$os" in
            centos-9) image="quay.io/centos/centos:stream9" ;;
            rocky-8) image="rockylinux:8" ;;
            rocky-9) image="rockylinux:9" ;;
            almalinux-8) image="almalinux:8" ;;
            almalinux-9) image="almalinux:9" ;;
            fedora-38) image="fedora:38" ;;
            fedora-39) image="fedora:39" ;;
            *) image="$os" ;;
          esac
          echo "image=$image" >> $GITHUB_OUTPUT
          echo "Using Docker image: $image"

      - name: Build RPM package
        run: |
          # Create build directory
          mkdir -p build/rpm

          # Create spec file with proper version and release
          sed -e "s/%{version}/${{ steps.version.outputs.rpm_version }}/g" \
              -e "s/^Release:.*/Release:        ${{ steps.version.outputs.rpm_release }}%{?dist}/" \
            packaging/rpm/slurm-exporter.spec > build/rpm/slurm-exporter.spec
          
          # Build using Docker container for target OS
          docker run --rm \
            --platform linux/${{ matrix.arch == 'x86_64' && 'amd64' || 'arm64' }} \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ steps.docker_image.outputs.image }} \
            bash -c "
              # Install build dependencies
              if command -v dnf > /dev/null; then
                dnf install -y rpm-build rpmdevtools golang git make tar
              else
                yum install -y rpm-build rpmdevtools golang git make tar
              fi

              # Set up RPM build environment
              rpmdev-setuptree

              # Copy spec file
              cp build/rpm/slurm-exporter.spec ~/rpmbuild/SPECS/

              # Create source tarball from current directory
              tar czf ~/rpmbuild/SOURCES/slurm-exporter-${{ steps.version.outputs.rpm_version }}.tar.gz \
                --transform='s,^\.,slurm-exporter-${{ steps.version.outputs.rpm_version }},' \
                --exclude='.git' \
                --exclude='build' \
                --exclude='*.rpm' \
                --exclude='*.deb' \
                .

              # Build binary RPM (skip source RPM for development builds)
              rpmbuild -bb ~/rpmbuild/SPECS/slurm-exporter.spec

              # Copy results
              mkdir -p build/rpm/${{ matrix.os }}-${{ matrix.arch }}
              cp ~/rpmbuild/RPMS/*/*.rpm build/rpm/${{ matrix.os }}-${{ matrix.arch }}/ || true
              cp ~/rpmbuild/SRPMS/*.rpm build/rpm/${{ matrix.os }}-${{ matrix.arch }}/ || true
            "

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-${{ matrix.os }}-${{ matrix.arch }}
          path: build/rpm/${{ matrix.os }}-${{ matrix.arch }}/*.rpm
          retention-days: 30

  build-deb:
    name: Build DEB Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-24.04, debian-11, debian-12]
        arch: [amd64, arm64]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            RPM_VERSION="$VERSION"
            RPM_RELEASE="1"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            RPM_VERSION="$VERSION"
            RPM_RELEASE="1"
          else
            GIT_SHA=$(git rev-parse --short HEAD)
            VERSION="0.0.0.dev.${GIT_SHA}"
            RPM_VERSION="0.0.0"
            RPM_RELEASE="0.dev.git${GIT_SHA}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rpm_version=$RPM_VERSION" >> $GITHUB_OUTPUT
          echo "rpm_release=$RPM_RELEASE" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION (RPM: $RPM_VERSION-$RPM_RELEASE)"

      - name: Set Docker image
        id: docker_image
        run: |
          # Convert matrix OS name to proper Docker image name
          os="${{ matrix.os }}"
          case "$os" in
            ubuntu-20.04) image="ubuntu:20.04" ;;
            ubuntu-22.04) image="ubuntu:22.04" ;;
            ubuntu-24.04) image="ubuntu:24.04" ;;
            debian-11) image="debian:11" ;;
            debian-12) image="debian:12" ;;
            *) image="$os" ;;
          esac
          echo "image=$image" >> $GITHUB_OUTPUT
          echo "Using Docker image: $image"

      - name: Build DEB package
        run: |
          # Create build directory
          mkdir -p build/deb
          
          # Update changelog with current version
          sed -i "1s/slurm-exporter (.*)/slurm-exporter (${{ steps.version.outputs.version }}-1)/" \
            packaging/deb/debian/changelog
          
          # Build using Docker container for target OS
          docker run --rm \
            --platform linux/${{ matrix.arch }} \
            -v $(pwd):/workspace \
            -w /workspace \
            ${{ steps.docker_image.outputs.image }} \
            bash -c "
              # Update package list
              apt-get update

              # Install build dependencies
              # Note: dh-systemd merged into debhelper in Ubuntu 20.04+
              apt-get install -y \
                build-essential \
                debhelper \
                devscripts \
                dpkg-dev \
                golang \
                git \
                make

              # Verify Go installation
              go version

              # Copy Debian packaging files
              cp -r packaging/deb/debian .

              # Build source package
              dpkg-buildpackage -S -us -uc

              # Build binary package
              dpkg-buildpackage -b -us -uc

              # Copy results
              mkdir -p build/deb/${{ matrix.os }}-${{ matrix.arch }}
              cp ../*.deb build/deb/${{ matrix.os }}-${{ matrix.arch }}/ || true
              cp ../*.dsc build/deb/${{ matrix.os }}-${{ matrix.arch }}/ || true
              cp ../*.tar.* build/deb/${{ matrix.os }}-${{ matrix.arch }}/ || true
            "

      - name: Upload DEB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-${{ matrix.os }}-${{ matrix.arch }}
          path: build/deb/${{ matrix.os }}-${{ matrix.arch }}/*
          retention-days: 30

  create-repositories:
    name: Create Package Repositories
    runs-on: ubuntu-latest
    needs: [build-rpm, build-deb]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set up GPG
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          echo "use-agent" >> ~/.gnupg/gpg.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --sign --detach-sign --armor /dev/null

      - name: Create RPM repository
        run: |
          # Install createrepo
          sudo apt-get update
          sudo apt-get install -y createrepo-c rpm
          
          # Create repository structure
          # Note: CentOS 7 and 8 are EOL - use Rocky/AlmaLinux instead
          mkdir -p repo/rpm/centos/9/{x86_64,aarch64}
          mkdir -p repo/rpm/rocky/{8,9}/{x86_64,aarch64}
          mkdir -p repo/rpm/almalinux/{8,9}/{x86_64,aarch64}
          mkdir -p repo/rpm/fedora/{38,39}/{x86_64,aarch64}
          
          # Copy RPM packages to repository
          find artifacts -name "*.rpm" -type f | while read rpm; do
            # Extract OS and arch from path
            os_arch=$(echo "$rpm" | sed 's/.*rpm-packages-\([^/]*\).*/\1/')
            os=$(echo "$os_arch" | cut -d'-' -f1-2)
            arch=$(echo "$os_arch" | cut -d'-' -f3)
            
            # Map OS names
            case "$os" in
              centos-*) repo_os="centos/${os#centos-}" ;;
              rocky-*) repo_os="rocky/${os#rocky-}" ;;
              almalinux-*) repo_os="almalinux/${os#almalinux-}" ;;
              fedora-*) repo_os="fedora/${os#fedora-}" ;;
            esac
            
            # Copy to repository
            cp "$rpm" "repo/rpm/$repo_os/$arch/"
          done
          
          # Create repository metadata
          find repo/rpm -type d -name "x86_64" -o -name "aarch64" | while read dir; do
            if [ -n "$(ls -A "$dir" 2>/dev/null)" ]; then
              createrepo_c "$dir"
              # Sign repository metadata
              gpg --batch --yes --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                --detach-sign --armor "$dir/repodata/repomd.xml"
            fi
          done

      - name: Create DEB repository
        run: |
          # Install apt-ftparchive
          sudo apt-get install -y apt-utils
          
          # Create repository structure
          mkdir -p repo/deb/ubuntu/{focal,jammy,noble}/amd64
          mkdir -p repo/deb/ubuntu/{focal,jammy,noble}/arm64
          mkdir -p repo/deb/debian/{bullseye,bookworm}/amd64
          mkdir -p repo/deb/debian/{bullseye,bookworm}/arm64
          
          # Copy DEB packages to repository
          find artifacts -name "*.deb" -type f | while read deb; do
            # Extract OS and arch from path
            os_arch=$(echo "$deb" | sed 's/.*deb-packages-\([^/]*\).*/\1/')
            os_version=$(echo "$os_arch" | cut -d'-' -f1-2)
            arch=$(echo "$os_arch" | cut -d'-' -f3)
            
            # Map OS versions to codenames
            case "$os_version" in
              ubuntu-20.04) codename="focal" ;;
              ubuntu-22.04) codename="jammy" ;;
              ubuntu-24.04) codename="noble" ;;
              debian-11) codename="bullseye"; os_version="debian" ;;
              debian-12) codename="bookworm"; os_version="debian" ;;
            esac
            
            # Copy to repository
            cp "$deb" "repo/deb/${os_version%-*}/$codename/$arch/"
          done
          
          # Create repository metadata for each distribution
          for os in ubuntu debian; do
            for codename in focal jammy noble bullseye bookworm; do
              if [ "$os" = "ubuntu" ] && [[ "$codename" =~ ^(bullseye|bookworm)$ ]]; then
                continue
              fi
              if [ "$os" = "debian" ] && [[ "$codename" =~ ^(focal|jammy|noble)$ ]]; then
                continue
              fi
              
              repo_dir="repo/deb/$os/$codename"
              if [ -d "$repo_dir" ]; then
                cd "$repo_dir"
                
                # Create Packages files
                for arch in amd64 arm64; do
                  if [ -d "$arch" ] && [ -n "$(ls -A "$arch" 2>/dev/null)" ]; then
                    apt-ftparchive packages "$arch" > "Packages-$arch"
                    gzip -c "Packages-$arch" > "Packages-$arch.gz"
                  fi
                done
                
                # Create Release file
                cat > Release << EOF
          Origin: SLURM Exporter
          Label: SLURM Exporter
          Suite: $codename
          Codename: $codename
          Architectures: amd64 arm64
          Components: main
          Description: SLURM Exporter packages for $os $codename
          Date: $(date -u '+%a, %d %b %Y %H:%M:%S UTC')
          EOF
                
                # Sign Release file
                gpg --batch --yes --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                  --clearsign -o InRelease Release
                gpg --batch --yes --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                  --detach-sign -a -o Release.gpg Release
                
                cd - > /dev/null
              fi
            done
          done

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.rpm
            artifacts/**/*.deb
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy repositories
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          REPO_HOST: ${{ secrets.REPO_HOST }}
          REPO_PATH: ${{ secrets.REPO_PATH }}
        run: |
          # Set up SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$REPO_HOST" >> ~/.ssh/known_hosts
          
          # Deploy repositories
          rsync -avz --delete repo/ "$REPO_HOST:$REPO_PATH/"

  test-packages:
    name: Test Packages
    runs-on: ubuntu-latest
    needs: [build-rpm, build-deb]
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        os: [centos:8, ubuntu:22.04]
        arch: [amd64]
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Test package installation
        run: |
          # Test RPM installation
          if [[ "${{ matrix.os }}" =~ centos|rocky|almalinux|fedora ]]; then
            docker run --rm -v $(pwd)/artifacts:/artifacts ${{ matrix.os }} bash -c "
              find /artifacts -name '*.rpm' | head -1 | xargs dnf install -y
              systemctl status slurm-exporter --no-pager || true
              slurm-exporter --version
            "
          fi

          # Test DEB installation
          if [[ "${{ matrix.os }}" =~ ubuntu|debian ]]; then
            docker run --rm -v $(pwd)/artifacts:/artifacts ${{ matrix.os }} bash -c "
              apt-get update
              find /artifacts -name '*.deb' | head -1 | xargs apt-get install -y
              systemctl status slurm-exporter --no-pager || true
              slurm-exporter --version
            "
          fi