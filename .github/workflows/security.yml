# SPDX-FileCopyrightText: 2025 Jon Thor Kristinsson
# SPDX-License-Identifier: Apache-2.0

name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  GO_VERSION: '1.24'

jobs:
  # Static Application Security Testing
  sast:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      # Gosec - Go security checker
      - name: Install Gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run Gosec Security Scanner
        run: gosec -exclude=G101,G104,G115,G301,G304,G306,G404 -fmt sarif -out gosec-results.sarif ./...

      - name: Upload Gosec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      # StaticCheck - Go static analysis
      - name: Install StaticCheck
        run: go install honnef.co/go/tools/cmd/staticcheck@latest

      - name: Run StaticCheck
        continue-on-error: true
        run: |
          # Run staticcheck and output to SARIF format
          staticcheck -f sarif ./... > staticcheck-results.sarif || true

          # Validate SARIF has proper structure
          if [ -s staticcheck-results.sarif ] && grep -q '"results"' staticcheck-results.sarif; then
            echo "## ‚ö†Ô∏è Static Analysis Issues Found" >> $GITHUB_STEP_SUMMARY
            # Show issues in readable format too
            staticcheck ./... || true
          else
            echo "‚úÖ No static analysis issues found" >> $GITHUB_STEP_SUMMARY
            # Create valid empty SARIF file
            cat > staticcheck-results.sarif <<'EOF'
{
  "version": "2.1.0",
  "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "staticcheck",
          "informationUri": "https://staticcheck.io/"
        }
      },
      "results": []
    }
  ]
}
EOF
          fi

      - name: Upload StaticCheck results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('staticcheck-results.sarif') != ''
        with:
          sarif_file: staticcheck-results.sarif
          category: staticcheck

      # Upload security scan artifacts
      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            gosec-results.sarif
            staticcheck-results.sarif
          retention-days: 30

  # Go Vulnerability Check
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Run govulncheck
      uses: golang/govulncheck-action@v1
      with:
        go-version-file: 'go.mod'
        output-format: sarif
        output-file: govulncheck-results.sarif

    - name: Upload vulnerability results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      continue-on-error: true
      with:
        sarif_file: govulncheck-results.sarif
        category: govulncheck

    - name: Upload govulncheck results as artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: govulncheck-results
        path: govulncheck-results.sarif

  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [ 'go' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"

  # Dependency Review
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Dependency Review
      continue-on-error: true
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
        comment-summary-in-pr: true

  # Container Security Scanning
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: slurm-exporter:security-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Trivy - Container vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: 'slurm-exporter:security-scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: trivy-results.sarif
          category: trivy

      # Grype - Additional container scanner
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Grype container scan
        run: |
          grype slurm-exporter:security-scan -o json > grype-results.json || true
          grype slurm-exporter:security-scan -o table || true

      - name: Upload container scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-results
          path: |
            trivy-results.sarif
            grype-results.json
          retention-days: 30

  # Dependency License Scanning
  license-scan:
    name: License Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      # go-licenses - License detection
      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check licenses
        run: |
          echo "## üìÑ License Compliance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Generate license report
          go-licenses report ./... > license-report.txt || true
          
          # Check for forbidden licenses
          FORBIDDEN_LICENSES="GPL-2.0 GPL-3.0 AGPL-1.0 AGPL-3.0"
          
          echo "### Dependencies and Licenses:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -20 license-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Check for license violations
          for license in $FORBIDDEN_LICENSES; do
            if grep -q "$license" license-report.txt; then
              echo "‚ùå Found forbidden license: $license" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done
          
          echo "‚úÖ No forbidden licenses detected" >> $GITHUB_STEP_SUMMARY

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: license-report.txt
          retention-days: 90

  # Secret Scanning
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # TruffleHog - Secret scanner
      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      # GitLeaks - Additional secret scanner
      - name: Install GitLeaks
        run: |
          # Get latest release version
          GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          wget -O gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: Run GitLeaks scan
        run: |
          gitleaks detect --source . --report gitleaks-report.json || true
          
          if [ -s gitleaks-report.json ]; then
            echo "## üîê Secret Detection Results" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Potential secrets detected! Check the artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload secret scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results
          path: gitleaks-report.json
          retention-days: 30

  # Security Policy Compliance
  security-policy:
    name: Security Policy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check security policy compliance
        run: |
          echo "## üõ°Ô∏è Security Policy Compliance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for required security files
          REQUIRED_FILES="SECURITY.md .github/workflows/security.yml"
          OPTIONAL_FILES="CODE_OF_CONDUCT.md CONTRIBUTING.md"
          
          echo "### Required Security Files:" >> $GITHUB_STEP_SUMMARY
          for file in $REQUIRED_FILES; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå $file (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommended Files:" >> $GITHUB_STEP_SUMMARY
          for file in $OPTIONAL_FILES; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è $file (recommended)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Check Dockerfile security best practices
          if [ -f "Dockerfile" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Dockerfile Security:" >> $GITHUB_STEP_SUMMARY
            
            # Check for non-root user
            if grep -q "USER.*[^0]" Dockerfile; then
              echo "‚úÖ Non-root user configured" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è Consider using non-root user" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Check for secrets in Dockerfile
            if grep -i -E "(password|secret|key|token)" Dockerfile; then
              echo "‚ùå Potential secrets in Dockerfile" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚úÖ No obvious secrets in Dockerfile" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # OpenSSF Scorecard
  scorecard:
    name: OpenSSF Scorecard
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Run analysis
      uses: ossf/scorecard-action@v2.4.0
      with:
        results_file: scorecard-results.sarif
        results_format: sarif
        publish_results: true

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v4
      continue-on-error: true
      with:
        sarif_file: scorecard-results.sarif
        category: scorecard

  # Aggregate security report
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [sast, govulncheck, codeql, container-security, license-scan, secret-scan, security-policy]
    if: always()
    permissions:
      contents: read
      issues: write
    steps:
      - name: Download all security artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate security summary
        run: |
          echo "# üîí Security Scan Summary" >> security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Repository:** ${{ github.repository }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          # Scan results summary
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Scan Type | Status | Details |" >> security-summary.md
          echo "|-----------|--------|---------|" >> security-summary.md
          echo "| Static Analysis (SAST) | ${{ needs.sast.result == 'success' && '‚úÖ Pass' || '‚ùå Issues Found' }} | Gosec, StaticCheck |" >> security-summary.md
          echo "| Go Vulnerabilities | ${{ needs.govulncheck.result == 'success' && '‚úÖ Pass' || '‚ùå Vulnerabilities Found' }} | govulncheck |" >> security-summary.md
          echo "| CodeQL Analysis | ${{ needs.codeql.result == 'success' && '‚úÖ Pass' || '‚ùå Issues Found' }} | Security and quality queries |" >> security-summary.md
          echo "| Container Security | ${{ needs.container-security.result == 'success' && '‚úÖ Pass' || '‚ùå Vulnerabilities Found' }} | Trivy, Grype |" >> security-summary.md
          echo "| License Compliance | ${{ needs.license-scan.result == 'success' && '‚úÖ Pass' || '‚ùå License Issues' }} | Dependency licenses |" >> security-summary.md
          echo "| Secret Detection | ${{ needs.secret-scan.result == 'success' && '‚úÖ Pass' || '‚ùå Secrets Found' }} | TruffleHog, GitLeaks |" >> security-summary.md
          echo "| Security Policy | ${{ needs.security-policy.result == 'success' && '‚úÖ Pass' || '‚ö†Ô∏è Policy Issues' }} | Security files and practices |" >> security-summary.md
          echo "" >> security-summary.md
          
          # Add recommendations
          echo "## üéØ Recommendations" >> security-summary.md
          echo "" >> security-summary.md
          
          if [ "${{ needs.sast.result }}" != "success" ]; then
            echo "- üîç **Review static analysis findings** - Check SARIF files for code security issues" >> security-summary.md
          fi

          if [ "${{ needs.govulncheck.result }}" != "success" ]; then
            echo "- üîí **Update vulnerable Go dependencies** - Known vulnerabilities detected in Go modules" >> security-summary.md
          fi

          if [ "${{ needs.codeql.result }}" != "success" ]; then
            echo "- üîé **Review CodeQL findings** - Security and quality issues detected in code" >> security-summary.md
          fi

          if [ "${{ needs.container-security.result }}" != "success" ]; then
            echo "- üê≥ **Update container dependencies** - Vulnerable packages detected in container image" >> security-summary.md
          fi

          if [ "${{ needs.license-scan.result }}" != "success" ]; then
            echo "- üìÑ **Review license compliance** - Check for incompatible or forbidden licenses" >> security-summary.md
          fi

          if [ "${{ needs.secret-scan.result }}" != "success" ]; then
            echo "- üîê **Remove detected secrets** - Rotate any exposed credentials and remove from history" >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## üìö Resources" >> security-summary.md
          echo "" >> security-summary.md
          echo "- [Security Policy](SECURITY.md)" >> security-summary.md
          echo "- [OWASP Go Security Guide](https://owasp.org/www-project-go-secure-coding-practices-guide/)" >> security-summary.md
          echo "- [Container Security Best Practices](https://owasp.org/www-project-docker-top-10/)" >> security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      # Create GitHub issue for security failures (only on main branch)
      - name: Create security issue
        if: |
          github.ref == 'refs/heads/main' &&
          (needs.sast.result == 'failure' ||
           needs.govulncheck.result == 'failure' ||
           needs.codeql.result == 'failure' ||
           needs.container-security.result == 'failure' ||
           needs.secret-scan.result == 'failure')
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            // Add security audit info if available
            let auditInfo = '';
            if (process.env.SECURITY_AUDIT_AVAILABLE === 'true') {
              auditInfo = '\n\n## üîç Security Audit\n\nA comprehensive security audit was run. Check the workflow artifacts for detailed results.\n\n';
            }
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Security Issues Detected - ${new Date().toISOString().split('T')[0]}`,
              body: `${summary}${auditInfo}\n\n---\n*This issue was automatically created by the security scanning workflow.*\n\n### üìã Next Steps\n- [ ] Review security scan results\n- [ ] Address critical and high-priority findings\n- [ ] Update dependencies with known vulnerabilities\n- [ ] Run security audit script locally for detailed analysis\n\n### üîó Resources\n- [Security Policy](SECURITY.md)\n- [Security Configuration Guide](docs/security-configuration.md)\n- [Security Audit Script](scripts/security-audit.sh)`,
              labels: ['security', 'automated', 'priority-high']
            });